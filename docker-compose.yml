# FSOA Docker Compose配置
version: '3.8'

services:
  # FSOA Web应用
  fsoa-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fsoa-web
    ports:
      - "8501:8501"
    environment:
      # DeepSeek配置
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      
      # Metabase配置
      - METABASE_URL=${METABASE_URL}
      - METABASE_USERNAME=${METABASE_USERNAME}
      - METABASE_PASSWORD=${METABASE_PASSWORD}
      - METABASE_DATABASE_ID=${METABASE_DATABASE_ID:-1}
      
      # 企微配置
      - WECHAT_WEBHOOK_URLS=${WECHAT_WEBHOOK_URLS}
      
      # 数据库配置
      - DATABASE_URL=sqlite:///app/data/fsoa.db
      
      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/fsoa.log
      
      # Agent配置
      - AGENT_EXECUTION_INTERVAL=${AGENT_EXECUTION_INTERVAL:-60}
      - USE_LLM_OPTIMIZATION=${USE_LLM_OPTIMIZATION:-true}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.1}
      
      # 运行环境
      - DEBUG=false
      - TESTING=false
    volumes:
      - fsoa_data:/app/data
      - fsoa_logs:/app/logs
      - ./config:/app/config:ro  # 可选：外部配置文件
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - fsoa-network
    depends_on:
      - fsoa-agent

  # FSOA Agent服务
  fsoa-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fsoa-agent
    command: ["python", "scripts/start_agent.py"]
    environment:
      # 与web服务相同的环境变量
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      - METABASE_URL=${METABASE_URL}
      - METABASE_USERNAME=${METABASE_USERNAME}
      - METABASE_PASSWORD=${METABASE_PASSWORD}
      - METABASE_DATABASE_ID=${METABASE_DATABASE_ID:-1}
      - WECHAT_WEBHOOK_URLS=${WECHAT_WEBHOOK_URLS}
      - DATABASE_URL=sqlite:///app/data/fsoa.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/fsoa-agent.log
      - AGENT_EXECUTION_INTERVAL=${AGENT_EXECUTION_INTERVAL:-60}
      - USE_LLM_OPTIMIZATION=${USE_LLM_OPTIMIZATION:-true}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.1}
      - DEBUG=false
      - TESTING=false
    volumes:
      - fsoa_data:/app/data
      - fsoa_logs:/app/logs
      - ./config:/app/config:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - fsoa-network

  # Nginx反向代理（可选）
  fsoa-nginx:
    image: nginx:alpine
    container_name: fsoa-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro  # SSL证书目录
      - fsoa_logs:/var/log/nginx
    restart: unless-stopped
    depends_on:
      - fsoa-web
    networks:
      - fsoa-network
    profiles:
      - production  # 仅在生产环境启用

# 数据卷
volumes:
  fsoa_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
  fsoa_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./logs

# 网络
networks:
  fsoa-network:
    driver: bridge
