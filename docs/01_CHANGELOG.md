# FSOA 变更日志

Field Service Operations Assistant - 版本变更记录

本文档记录项目的重要变更，遵循 [Keep a Changelog](https://keepachangelog.com/) 规范。

## [未发布] - TBD

### 计划新增
- Agent执行性能优化
- 多语言消息模板支持
- 高级分析和报表功能
- 移动端适配

### 计划改进
- UI界面优化
- 错误处理增强
- 文档完善

## [0.2.1] - 2025-06-26

### 修复
- **时区问题修复**: 所有时间记录现在使用中国时区（UTC+8）
- **数据库时间**: 统一使用中国本地时间存储和显示
- **Web界面时间**: 所有时间显示都是中国时区
- **业务时间计算**: 工作时间计算基于中国时区

### 新增
- **时区工具模块**: `timezone_utils.py` 统一处理时区转换
- **时区迁移脚本**: 自动将现有UTC时间转换为中国时间
- **时区测试工具**: 验证时区功能正常工作

### 技术改进
- 替换所有 `datetime.now()` 为 `now_china_naive()`
- 替换所有 `datetime.utcnow()` 为 `now_china_naive()`
- Web界面时间格式化使用 `format_china_time()`
- 数据库默认时间使用中国时区

## [1.0.0] - 2025-06-25

### 新增
- **工作时间计算模块**: 实现工作时间（早9点到晚7点）的精确计算
- **12小时违规检测**: 新增违规阈值，超过12小时工作时间即算违规
- **2小时冷静时间**: 通知发送后2小时内不再重复提醒
- **5次重试机制**: 每个通知任务最多重试5次，理论上可提醒6次
- **违规通知类型**: 新增VIOLATION通知类型，区别于标准和升级通知
- **工作时间SLA**: 所有SLA时间计算改为基于工作时间而非自然时间

### 变更
- **SLA规则重构**:
  - 待预约：12h违规 → 24h标准 → 24h升级
  - 暂不上门：12h违规 → 48h标准 → 48h升级
- **通知冷静时间**: 从30分钟延长到2小时（120分钟）
- **最大重试次数**: 从3次增加到5次
- **时间计算方式**: 从自然时间改为工作时间计算

### 技术改进
- **BusinessTimeCalculator**: 新增工作时间计算器类
- **OpportunityInfo模型**: 增加is_violation字段和工作时间计算支持
- **NotificationTask模型**: 增加冷静时间和重试控制字段
- **通知管理器**: 重构支持新的通知类型和重试机制
- **业务格式化器**: 新增违规通知格式化方法

### 数据库变更
- notification_tasks表新增字段：
  - max_retry_count: 最大重试次数
  - cooldown_hours: 冷静时间（小时）
  - last_sent_at: 最后发送时间

## [0.2.0] - 2025-06-25

### 🚀 架构重构完成
- **管理器模式**: 实现了 `BusinessDataStrategy`、`NotificationTaskManager`、`AgentExecutionTracker` 三大核心管理器
- **数据分离**: 完成业务数据与Agent数据的清晰分离，移除概念混淆
- **工具重构**: 重构Agent工具集，提供统一的函数接口和错误处理
- **执行追踪**: 新增完整的Agent执行生命周期管理和状态追踪

### ✨ 新增功能
- **智能缓存**: 实现业务数据的智能缓存策略，支持TTL和手动刷新
- **分级通知**: 完善的组织级通知路由和升级机制
- **业务分析**: 新增逾期率、处理时长等业务指标分析
- **配置管理**: 数据库+环境变量的混合配置方案

### 🔧 技术优化
- **LangGraph集成**: 基于LangGraph的Agent编排引擎
- **错误处理**: 统一的异常处理和重试机制
- **日志系统**: 完善的结构化日志记录
- **数据模型**: 清晰的Pydantic数据模型定义

### 🧹 代码清理
- **移除过期文档**: 清理临时分析报告和过期实施计划
- **脚本整理**: 移除17个临时测试脚本，保留核心启动脚本
- **配置统一**: 移除重复的配置系统，统一为数据库+环境变量方案

### 📋 Sprint完成总结
- **Sprint 1-3**: 基础架构、Agent核心功能、环境配置部署
- **Sprint 4**: 真实业务集成，Metabase数据源集成，分级通知系统
- **Sprint 5**: 架构重构，管理器模式实现，智能缓存系统

## [0.2.0] - 2025-06-25

### 🎉 重大改进
- **Web界面修复**: 完全修复了 Streamlit Web 界面的模块导入问题
- **配置系统优化**: 修复了环境变量解析和缓存问题
- **DeepSeek API兼容性**: 解决了 OpenAI 客户端版本兼容性问题

### ✨ 新增功能
- **环境测试脚本**: 添加了完整的环境验证和服务连接测试
- **便捷启动脚本**: 提供了 `start_web.py` 便捷启动 Web 界面
- **配置指南**: 新增详细的本地环境配置指南

### 🔧 技术修复
- **模块导入**: 修复了 Streamlit 应用的相对导入路径问题
- **配置加载**: 优化了配置重新加载机制，解决缓存问题
- **LangGraph兼容**: 更新了 LangGraph 的导入语法
- **环境变量**: 修复了 `.env` 文件中注释导致的解析错误

### 📚 文档更新
- **README**: 更新了安装和验证步骤
- **开发指南**: 添加了环境验证和故障排除章节
- **配置指南**: 完善了常见问题解决方案

### 🧹 代码清理
- **测试文件**: 清理了临时测试脚本，保留核心功能
- **Git忽略**: 添加了 `.gitignore` 文件，排除临时文件
- **项目结构**: 优化了项目文件组织

### ✅ 验证通过
- **环境测试**: 所有核心组件测试通过 (6/6)
- **服务连接**: 所有外部服务连接正常 (4/4)
- **Web功能**: 所有 Web 界面功能测试通过 (4/4)
- **Agent工作流**: Agent 执行流程完整验证

## [0.1.0] - 2025-06-24

### 🎯 初始版本
- **项目架构**: 建立了基于 LangGraph 的 Agent 架构
- **核心功能**: 实现了任务监控、智能决策、通知发送
- **数据集成**: 集成了 Metabase 数据源
- **通知系统**: 实现了企微群通知功能
- **Web界面**: 基于 Streamlit 的管理界面
- **配置系统**: 灵活的环境配置管理

### 📋 核心模块
- **Agent编排器**: 基于 LangGraph 的智能工作流
- **决策引擎**: 规则+LLM 的混合决策系统
- **工具层**: 标准化的功能工具集合
- **数据层**: 统一的数据访问接口
- **通知层**: 多渠道通知发送机制

### 技术决策
- **Agent框架**：选择LangGraph作为Agent编排引擎
- **决策机制**：采用规则引擎+LLM的混合决策模式
- **数据集成**：通过Metabase API实现非侵入式数据获取
- **通知渠道**：基于企微Webhook的多群组通知
- **部署方式**：单机部署为主，支持容器化扩展

### 设计原则
- **Agentic特性**：体现主动性、自主决策、目标导向
- **KISS原则**：保持简单，避免过度设计
- **可扩展性**：模块化架构，支持功能扩展
- **企业级**：稳定可靠，支持生产环境使用

---

## 版本规范

### 版本号格式
采用语义化版本控制 (Semantic Versioning)：`MAJOR.MINOR.PATCH`

- **MAJOR**：不兼容的API变更
- **MINOR**：向后兼容的功能新增
- **PATCH**：向后兼容的问题修复

### 变更类型
- **新增 (Added)**：新功能
- **变更 (Changed)**：现有功能的变更
- **弃用 (Deprecated)**：即将移除的功能
- **移除 (Removed)**：已移除的功能
- **修复 (Fixed)**：问题修复
- **安全 (Security)**：安全相关的修复

### 发布流程
1. 更新版本号
2. 更新CHANGELOG
3. 创建Git标签
4. 发布Release
5. 部署到生产环境

---
> 变更日志帮助用户和开发者了解项目演进，请及时更新