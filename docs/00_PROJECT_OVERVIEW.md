# FSOA 项目概述

Field Service Operations Assistant - 现场服务运营助手

**当前版本**: v0.3.1
**项目状态**: ✅ 生产就绪
**最后更新**: 2025-06-30

## 1. 项目背景

### 业务痛点
- **人工监控效率低**：运营人员需要手动跟踪现场服务时效
- **响应不及时**：超时情况发现和处理存在延迟
- **重复性工作多**：大量时间花费在状态检查和提醒发送上
- **缺乏智能决策**：依赖人工经验判断，缺乏数据驱动的决策支持

### 解决方案
构建一个具备**主动性、自主决策、目标导向**的AI Agent系统，实现：
- 自动监控现场服务时效状态
- 智能判断和发送超时提醒
- 通过企业微信群自动通知相关人员
- 提升运营效率，减少人工干预

## 2. 项目目标

### 业务目标
- **提升时效合规率**：通过及时提醒提高现场服务SLA达成率
- **降低运营成本**：减少人工监控和提醒工作量
- **增强响应速度**：实现实时监控和即时通知
- **改善服务质量**：通过数据驱动优化服务流程

### 技术目标
- **验证Agentic AI**：体现主动性、自主决策、目标导向特性
- **探索LLM应用边界**：明确哪些场景需要LLM，哪些不需要
- **建立可扩展架构**：为未来功能扩展奠定基础
- **实现非侵入式集成**：不影响现有业务系统

## 3. 核心特性

### 3.1 核心特性
```
两级SLA通知机制
├── 4小时提醒通知 (reminder)
├── 8小时升级通知 (escalation)
├── 智能路由：组织群 vs 运营群
└── 动态SLA阈值配置

统一数据架构
├── OpportunityInfo统一模型
├── 管理器模式分层设计
├── 智能缓存系统
└── 数据一致性保障

智能决策系统
├── 规则引擎 + LLM混合决策
├── 可选的DeepSeek LLM增强
└── 智能降级和错误处理

动态消息模板
├── 基于数据库配置的SLA阈值
├── BusinessNotificationFormatter
├── 智能消息格式化
└── 企微群消息优化
```

## 4. 业务需求规格

### 4.1 业务场景
FSOA 系统用于监控和管理现场服务商机的跟进时效性，通过两级SLA通知机制确保销售人员及时跟进商机，提升客户服务质量和转化率。

### 4.2 SLA管理机制
- **4小时提醒**: 商机创建4小时后发送提醒通知到组织群
- **8小时升级**: 商机创建8小时后发送升级通知到运营群
- **动态配置**: 支持不同状态商机的差异化SLA阈值
- **智能路由**: 提醒通知到组织群，升级通知到运营群

### 4.3 数据源规格

#### Metabase 数据源
- **数据地址**: `http://metabase.fsgo365.cn:3000/question/1712`
- **API 端点**: `{METABASE_URL}/api/card/1712/query`
- **更新频率**: 每天更新一次
- **数据权限**: 普通密钥即可获取

#### 数据结构
```json
{
  "orderNum": "GD20250600803",
  "name": "客户",
  "address": "东方夏威夷南岸欧湖公寓",
  "supervisorName": "李纪龙",
  "createTime": "2025-6-14, 16:33",
  "orgName": "三河市中豫防水工程有限公司",
  "orderstatus": "待预约"
}
```

#### 关键字段说明
- **orderNum**: 工单号，唯一标识
- **name**: 客户姓名
- **address**: 客户地址
- **supervisorName**: 负责销售人员
- **createTime**: 商机创建时间
- **orgName**: 所属组织/公司
- **orderstatus**: 商机状态（待预约、暂不上门等）

### 4.4 业务规则

#### SLA 规则定义

**1. 待预约状态**
- **触发条件**: `orderstatus == "待预约"`
- **违规阈值**: 工作时间超过 12 小时
- **标准阈值**: 工作时间超过 24 小时
- **升级阈值**: 工作时间超过 24 小时
- **业务含义**: 销售需要及时联系客户并在系统中填写预约时间

**2. 暂不上门状态**
- **触发条件**: `orderstatus == "暂不上门"`
- **违规阈值**: 工作时间超过 12 小时
- **标准阈值**: 工作时间超过 48 小时
- **升级阈值**: 工作时间超过 48 小时
- **业务含义**: 客户首次通话未同意上门，需要持续跟进

#### 工作时间定义
- **工作时间**: 早上9点到晚上7点（10小时）
- **工作日**: 周一到周五
- **时间计算**: 所有SLA时间均按工作时间计算
- **数据更新**: 每60分钟更新一次，销售及时处理后系统自动停止提醒

#### 通知机制

**违规通知（12小时）**
- **触发条件**: 工作时间超过 12 小时
- **通知对象**: 对应 orgName 的企微群
- **通知方式**: 机器人消息
- **冷静时间**: 2小时
- **重试次数**: 最多5次

**标准逾期通知**
- **待预约**: 工作时间超过 24 小时
- **暂不上门**: 工作时间超过 48 小时
- **通知对象**: 对应 orgName 的企微群
- **通知方式**: 机器人消息
- **冷静时间**: 2小时
- **重试次数**: 最多5次

**升级逾期通知**
- **待预约**: 工作时间超过 24 小时
- **暂不上门**: 工作时间超过 48 小时
- **通知对象**: 内部运营群 + @特定人员
- **通知方式**: 机器人消息 + 人员提醒
- **冷静时间**: 2小时
- **重试次数**: 最多5次

### 4.5 业务指标

#### 核心 KPI
1. **逾期率**: 各状态任务的逾期比例
   - 待预约逾期率 = 超过24h的待预约任务 / 总待预约任务
   - 暂不上门逾期率 = 超过48h的暂不上门任务 / 总暂不上门任务

2. **平均处理时长**: 从创建到状态变更的时间
   - 平均预约时长 = 从创建到预约完成的平均时间
   - 平均跟进时长 = 从暂不上门到状态变更的平均时间

3. **通知响应率**: 通知后任务状态变更的比例
   - 4小时响应率 = 通知后4小时内状态变更的任务比例
   - 24小时响应率 = 通知后24小时内状态变更的任务比例

4. **组织绩效排名**: 各 orgName 的 SLA 达成情况
   - SLA达成率 = 按时处理的任务 / 总任务数
   - 平均响应时间 = 各组织的平均任务处理时间

### 4.6 验收标准

#### 功能验收
- [ ] 正确获取和解析 Metabase Card 1712 数据
- [ ] 准确计算各状态任务的逾期情况
- [ ] 按业务规则发送分级通知
- [ ] Web 界面展示真实数据和统计
- [ ] 配置管理功能正常工作

#### 性能验收
- [ ] 数据处理延迟 < 5 分钟
- [ ] 通知发送延迟 < 1 分钟
- [ ] Web 界面响应时间 < 2 秒
- [ ] 系统 7x24 小时稳定运行

#### 业务验收
- [ ] 销售人员能及时收到逾期提醒
- [ ] 运营人员能实时监控任务状态
- [ ] 逾期任务数量明显减少
- [ ] 用户满意度达到预期目标
├── 分级通知路由决策
└── 自适应策略调整

目标导向 (Goal-Oriented)
├── 以提升时效合规为目标
├── 结果驱动的行为优化
└── 持续学习和改进
```

### 3.2 技术特性
- **非侵入式**：通过Metabase API获取数据，不修改现有系统
- **管理器架构**：BusinessDataStrategy、NotificationTaskManager、AgentExecutionTracker三大核心管理器
- **智能缓存**：支持TTL缓存、手动刷新、数据一致性验证
- **分级通知**：组织级通知路由、升级机制、频率控制
- **混合决策**：结合规则引擎和LLM的智能决策
- **完整追踪**：Agent执行生命周期管理和详细状态记录
- **可观测性**：结构化日志、性能指标、错误追踪
- **可配置性**：数据库+环境变量的灵活配置方案

## 4. 系统架构概览

```
数据流向：
Metabase → Agent Engine → Decision Engine → Notification → Feedback Loop
   ↓           ↓              ↓              ↓           ↓
业务数据 → 状态分析 → 智能决策 → 消息发送 → 效果评估

技术栈：
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  Frontend   │  │   Backend   │  │   Storage   │
│             │  │             │  │             │
│ Streamlit   │  │ LangGraph   │  │  SQLite     │
│ Web UI      │  │ Agent       │  │  Database   │
│             │  │ Engine      │  │             │
└─────────────┘  └─────────────┘  └─────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
              ┌─────────────┐
              │ Integration │
              │             │
              │ Metabase    │
              │ WeChat      │
              │ DeepSeek    │
              └─────────────┘
```

## 5. 核心业务流程

### 5.1 主流程
```
1. 定时触发 (每小时)
   ↓
2. 从Metabase获取任务数据
   ↓
3. 分析任务状态和时效
   ↓
4. 决策是否需要提醒
   ├── 规则判断：基于SLA时间
   └── LLM推理：优先级和内容优化
   ↓
5. 发送企微通知
   ↓
6. 记录执行结果
   ↓
7. 更新任务状态
```

### 5.2 决策逻辑
```python
# 混合决策示例
def decide_action(task):
    # 规则引擎：硬性判断
    if task.overdue_hours > task.sla_hours:
        priority = "high" if task.overdue_hours > task.sla_hours * 1.5 else "normal"
        
        # LLM推理：内容优化（可选）
        if use_llm_optimization:
            message = llm_generate_message(task, priority)
        else:
            message = template_message(task, priority)
            
        return {"action": "notify", "priority": priority, "message": message}
    
    return {"action": "skip"}
```

## 6. 价值主张

### 6.1 对运营人员
- **减少重复工作**：自动化监控和提醒，释放人力资源
- **提升响应速度**：实时监控，及时发现问题
- **数据驱动决策**：基于历史数据和智能分析的决策支持
- **工作质量提升**：减少人为遗漏，提高工作准确性

### 6.2 对组织
- **成本降低**：减少人工成本，提高运营效率
- **服务质量提升**：更好的时效管理，提升客户满意度
- **数字化转型**：引入AI技术，推动业务智能化
- **竞争优势**：先进的运营管理能力

### 6.3 对技术团队
- **技术探索**：验证Agentic AI在企业场景的应用
- **架构实践**：建立可扩展的AI Agent系统架构
- **经验积累**：积累LLM应用和Agent开发经验
- **创新驱动**：推动技术创新和业务创新结合

## 7. 项目状态

### 7.1 当前进展
- ✅ **Phase 1**: 基础架构搭建 (100% 完成)
- ✅ **Phase 2**: Agent核心功能 (100% 完成)
- ✅ **Phase 3**: 功能完善和测试 (100% 完成)
- ✅ **Phase 4**: 真实业务集成 (100% 完成)
- ✅ **Phase 5**: SLA规则增强 (100% 完成) - v0.2.0
- 📋 **Phase 6**: 生产优化和扩展 (规划中)

### 7.2 v0.2.0 新功能成果
- ✅ **工作时间计算**: 基于工作时间（9-19点）的精确SLA计算
- ✅ **12小时违规检测**: 新增违规阈值，提升响应速度
- ✅ **2小时冷静时间**: 避免频繁打扰，提升用户体验
- ✅ **5次重试机制**: 确保重要通知不遗漏
- ✅ **分级通知体系**: 违规→标准→升级的渐进式提醒
- ✅ **Web界面增强**: 支持新功能的完整UI界面

### 7.3 真实业务集成成果
- ✅ **Metabase集成**: 成功连接Card 1712，获取47条真实商机数据
- ✅ **业务逻辑验证**: SLA规则和逾期检测完全正常
- ✅ **数据分析**: 识别出31个逾期商机，涉及10个组织
- ✅ **通知系统**: 企微群分级通知机制已完成

## 8. 成功指标

### 8.1 业务指标
- **时效合规率提升**：目标提升20%以上
- **响应时间缩短**：从小时级降低到分钟级
- **人工工作量减少**：减少80%的重复性监控工作
- **客户满意度提升**：通过更好的服务时效管理

### 8.2 技术指标
- **系统可用性**：99%以上的稳定运行
- **响应准确性**：95%以上的正确决策率
- **处理效率**：支持1000+任务的并发处理
- **扩展性验证**：成功支持新业务场景接入

## 9. 风险控制

### 9.1 技术风险
- **API依赖**：Metabase和企微API的稳定性风险
- **LLM可用性**：DeepSeek服务中断的降级方案
- **数据准确性**：数据源异常的检测和处理

### 9.2 业务风险
- **过度通知**：频率控制和智能去重机制
- **误判风险**：人工审核和反馈机制
- **隐私安全**：敏感信息的保护和脱敏

### 9.3 缓解措施
- **多重验证**：规则+LLM的双重验证机制
- **降级方案**：纯规则模式作为LLM的备选方案
- **监控告警**：完善的系统监控和异常告警
- **人工干预**：保留人工审核和调整能力

## 10. 文档导航

### 10.1 核心设计文档
- **[10_ARCHITECTURE.md](10_ARCHITECTURE.md)** - 系统整体架构设计
- **[15_AGENT_DESIGN.md](15_AGENT_DESIGN.md)** - Agent核心机制详细设计 ⭐
- **[14_LLM_OPTIMIZATION_DESIGN.md](14_LLM_OPTIMIZATION_DESIGN.md)** - LLM优化机制设计
- **[12_SLA_DESIGN.md](12_SLA_DESIGN.md)** - SLA规则和时间计算设计
- **[13_NOTIFICATION_DESIGN.md](13_NOTIFICATION_DESIGN.md)** - 通知系统设计

### 10.2 功能设计文档
- **[11_DATA_IMPORT_DESIGN.md](11_DATA_IMPORT_DESIGN.md)** - 数据导入和处理设计
- **[20_API.md](20_API.md)** - API接口文档
- **[40_USER_GUIDE.md](40_USER_GUIDE.md)** - 用户使用指南

### 10.3 开发运维文档
- **[30_DEVELOPMENT.md](30_DEVELOPMENT.md)** - 开发环境和规范
- **[31_TESTING.md](31_TESTING.md)** - 测试策略和用例
- **[50_DEPLOYMENT.md](50_DEPLOYMENT.md)** - 部署和运维指南

### 10.4 项目管理文档
- **[00_SYSTEM_STATUS.md](00_SYSTEM_STATUS.md)** - 系统状态和监控
- **[01_CHANGELOG.md](01_CHANGELOG.md)** - 版本变更记录
- **[00_BACKLOG.md](00_BACKLOG.md)** - 功能需求和待办事项

### 10.5 文档阅读建议

**对于新开发者**：
1. 先阅读本概述文档了解项目背景
2. 阅读 `10_ARCHITECTURE.md` 了解整体架构
3. 重点阅读 `15_AGENT_DESIGN.md` 理解Agent核心机制 ⭐
4. 根据工作需要阅读相关的功能设计文档

**对于产品经理**：
1. 重点关注业务目标和核心特性部分
2. 阅读 `40_USER_GUIDE.md` 了解功能使用
3. 关注 `00_SYSTEM_STATUS.md` 了解系统状态

**对于运维人员**：
1. 重点阅读 `50_DEPLOYMENT.md` 部署指南
2. 关注 `00_SYSTEM_STATUS.md` 监控指标
3. 了解 `10_ARCHITECTURE.md` 中的部署架构

---
> 项目概述文档作为项目的北极星，指导整个开发过程
> ⭐ 标记的文档是理解系统核心机制的关键文档
