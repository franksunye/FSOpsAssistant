# FSOA 系统性测试计划 (2025年版)

## 📋 测试现状分析

### 当前问题
1. **架构重构影响**: TaskInfo → OpportunityInfo 迁移未完全反映在测试中
2. **数据库表缺失**: 测试环境缺少 agent_runs、system_config 等表
3. **Mock配置不当**: Mock对象配置与实际API不匹配
4. **方法名变更**: 实际实现与测试期望不一致

### 测试覆盖现状
- ✅ **模型测试**: 7/7 通过
- ⚠️ **管理器测试**: 部分通过，需要完善
- ❌ **集成测试**: 需要重构
- ❌ **端到端测试**: 需要更新

## 🎯 系统性测试计划

### 阶段一：基础设施修复 (优先级：🔴 高)

#### 1.1 测试环境标准化
- [ ] 修复测试数据库初始化，确保所有表都被创建
- [ ] 统一测试fixture，移除废弃的TaskInfo引用
- [ ] 更新conftest.py，提供完整的测试数据集
- [ ] 配置测试专用的环境变量

#### 1.2 Mock对象标准化
- [ ] 修正数据库管理器Mock，支持上下文管理器
- [ ] 更新Metabase客户端Mock，匹配实际API
- [ ] 完善WeChat客户端Mock，支持新的通知格式
- [ ] 统一Mock返回值格式

### 阶段二：单元测试完善 (优先级：🟡 中)

#### 2.1 管理器组件测试
- [ ] **BusinessDataStrategy**: 数据获取、缓存、一致性验证
- [ ] **NotificationTaskManager**: 任务创建、执行、重试机制
- [ ] **AgentExecutionTracker**: 运行追踪、步骤记录、统计分析

#### 2.2 核心业务逻辑测试
- [ ] **决策引擎**: 规则引擎、LLM集成、降级机制
- [ ] **通知系统**: SLA计算、升级机制、冷却时间
- [ ] **数据同步**: Metabase集成、缓存更新、错误处理

#### 2.3 工具函数测试
- [ ] **Agent工具**: 商机获取、通知发送、状态更新
- [ ] **时区工具**: 时间计算、工作日判断
- [ ] **配置管理**: 动态配置、环境变量处理

### 阶段三：集成测试重构 (优先级：🟡 中)

#### 3.1 组件间集成
- [ ] **数据流测试**: Metabase → Agent → 通知系统
- [ ] **错误传播**: 异常处理、降级机制
- [ ] **状态一致性**: 数据库状态与缓存同步

#### 3.2 外部系统集成
- [ ] **Metabase集成**: 连接测试、数据查询、错误处理
- [ ] **企微集成**: Webhook测试、消息格式、限流处理
- [ ] **LLM集成**: API调用、响应解析、降级处理

### 阶段四：端到端测试 (优先级：🟢 低)

#### 4.1 完整业务流程
- [ ] **正常流程**: 商机检测 → 决策 → 通知发送
- [ ] **异常流程**: 网络故障、API限制、数据异常
- [ ] **边界条件**: 大量数据、并发处理、资源限制

#### 4.2 性能测试
- [ ] **响应时间**: Agent执行时间、通知发送延迟
- [ ] **并发处理**: 多商机并行处理
- [ ] **资源使用**: 内存、CPU、数据库连接

## 🛠️ 实施策略

### 立即行动项 (本周)
1. **修复测试数据库初始化**
   ```bash
   # 确保测试环境包含所有必要的表
   python -c "from src.fsoa.data.database import DatabaseManager; db = DatabaseManager('sqlite:///test.db'); db.init_database()"
   ```

2. **更新测试fixture**
   - 移除所有TaskInfo引用
   - 使用OpportunityInfo替代
   - 添加完整的测试数据集

3. **修正Mock配置**
   - 数据库管理器支持上下文管理器
   - Metabase客户端匹配实际API
   - 返回值类型正确

### 短期目标 (2周内)
1. **单元测试通过率达到90%+**
2. **管理器组件测试覆盖率100%**
3. **核心业务逻辑测试完整**

### 中期目标 (1个月内)
1. **集成测试重构完成**
2. **端到端测试场景覆盖**
3. **性能基准测试建立**

## 📈 测试质量指标

### 覆盖率目标
- **单元测试**: ≥ 90%
- **集成测试**: ≥ 80%
- **端到端测试**: ≥ 70%

### 性能指标
- **Agent执行时间**: < 30秒
- **通知发送延迟**: < 5秒
- **数据同步时间**: < 10秒

### 可靠性指标
- **测试稳定性**: 连续10次运行成功率 ≥ 95%
- **错误恢复**: 异常场景下的正确处理
- **数据一致性**: 缓存与数据库同步准确性

## 🔧 工具和自动化

### 测试工具链
- **pytest**: 测试框架
- **pytest-cov**: 覆盖率分析
- **pytest-mock**: Mock对象管理
- **pytest-xdist**: 并行测试执行

### CI/CD集成
- **GitHub Actions**: 自动化测试运行
- **覆盖率报告**: 自动生成和上传
- **测试报告**: 详细的失败分析

### 监控和报告
- **测试仪表板**: 实时测试状态
- **趋势分析**: 测试质量变化
- **性能监控**: 执行时间趋势

## 📝 测试文档

### 测试指南更新
- [ ] 更新 `docs/31_TESTING.md`
- [ ] 创建测试最佳实践文档
- [ ] 编写Mock使用指南

### 开发者文档
- [ ] 测试环境搭建指南
- [ ] 新功能测试要求
- [ ] 测试数据管理规范

## 🎯 成功标准

### 短期成功标准 (2周)
- [ ] 所有单元测试通过
- [ ] 测试覆盖率 ≥ 80%
- [ ] CI/CD管道稳定运行

### 中期成功标准 (1个月)
- [ ] 集成测试完整覆盖
- [ ] 性能基准建立
- [ ] 自动化测试报告

### 长期成功标准 (3个月)
- [ ] 测试驱动开发流程
- [ ] 持续集成优化
- [ ] 质量门禁机制

---

**下一步行动**: 开始阶段一的基础设施修复工作，优先解决测试环境和Mock配置问题。
