# FSOA 架构重构计划

**版本**: v1.0  
**创建时间**: 2025-06-25  
**状态**: 进行中

## 🎯 重构目标

### 问题识别
当前系统存在概念混淆：
- **Task** 和 **Opportunity** 概念重叠
- 业务数据与Agent数据混合存储
- 数据转换逻辑复杂且容易出错
- 维护成本高，扩展性差

### 重构目标
1. **概念清晰化**: 明确区分Agent任务和业务数据
2. **数据分离**: 业务数据与Agent数据完全分离
3. **简化架构**: 移除冗余转换逻辑
4. **提升可维护性**: 清晰的数据流和职责分工

## 🏗️ 架构设计

### 数据分层设计
```
┌─────────────────────────────────────────────────────────┐
│                    外部数据源                            │
│  ┌─────────────────┐                                    │
│  │   Metabase      │ ← 只读业务数据源                    │
│  │   (商机数据)     │                                    │
│  └─────────────────┘                                    │
└─────────────────────────────────────────────────────────┘
                        ↓ 读取
┌─────────────────────────────────────────────────────────┐
│                  Agent 处理层                           │
│  ┌─────────────────┐  ┌─────────────────┐               │
│  │ Agent Engine    │  │ Business Logic  │               │
│  │ (代码实现)       │  │ (代码实现)       │               │
│  └─────────────────┘  └─────────────────┘               │
└─────────────────────────────────────────────────────────┘
                        ↓ 记录
┌─────────────────────────────────────────────────────────┐
│                   本地数据库                             │
│  ┌─────────────────┐  ┌─────────────────┐               │
│  │ Agent 执行记录   │  │ 通知任务管理     │               │
│  │ (agent_runs)    │  │(notification_   │               │
│  │ (agent_history) │  │    tasks)       │               │
│  └─────────────────┘  └─────────────────┘               │
└─────────────────────────────────────────────────────────┘
```

### 核心原则
1. **单一职责**: 每个组件只负责一个明确的功能
2. **数据分离**: 业务数据不持久化到本地（可选缓存）
3. **最小化存储**: 只存储Agent执行和通知管理必需的数据
4. **向后兼容**: 保持现有功能不变

## 📋 重构任务清单

### Phase 1: 数据模型重构 (Day 1)

#### 1.1 数据库表结构重新设计
- [ ] **创建新的数据库表**
  - [ ] `agent_runs` - Agent执行记录
  - [ ] `agent_history` - Agent执行明细
  - [ ] `notification_tasks` - 通知任务管理
  - [ ] `opportunity_cache` - 业务数据缓存(可选)

- [ ] **数据迁移脚本**
  - [ ] 创建数据库迁移脚本
  - [ ] 备份现有数据
  - [ ] 执行表结构变更

#### 1.2 数据模型类重构
- [ ] **移除冗余模型**
  - [ ] 移除 `TaskInfo` 相关代码
  - [ ] 清理 `TaskStatus` 枚举
  - [ ] 移除Task相关的数据库操作

- [ ] **新增Agent模型**
  - [ ] `AgentRun` - Agent执行记录模型
  - [ ] `AgentHistory` - Agent执行历史模型
  - [ ] `NotificationTask` - 通知任务模型

- [ ] **优化业务模型**
  - [ ] 优化 `OpportunityInfo` 模型
  - [ ] 添加缓存相关字段和方法

### Phase 2: Agent系统重构 (Day 2)

#### 2.1 Agent工具层重构
- [ ] **移除冗余函数**
  - [ ] 删除 `fetch_overdue_tasks()` 函数
  - [ ] 删除Task相关的转换逻辑
  - [ ] 清理相关的测试用例

- [ ] **新增管理器类**
  - [ ] `NotificationTaskManager` - 通知任务管理
  - [ ] `AgentExecutionTracker` - Agent执行追踪
  - [ ] `BusinessDataStrategy` - 业务数据处理策略

#### 2.2 数据访问层重构
- [ ] **重构DatabaseManager**
  - [ ] 移除Task相关的数据库操作
  - [ ] 新增Agent执行记录操作
  - [ ] 新增通知任务管理操作
  - [ ] 可选：新增业务数据缓存操作

- [ ] **优化Metabase客户端**
  - [ ] 移除 `get_overdue_tasks()` 方法
  - [ ] 优化 `get_overdue_opportunities()` 方法
  - [ ] 添加数据变化检测逻辑

### Phase 3: 业务逻辑优化 (Day 3)

#### 3.1 Agent编排器重构
- [ ] **简化执行流程**
  - [ ] 移除Task处理逻辑
  - [ ] 优化Opportunity处理流程
  - [ ] 集成新的管理器类

- [ ] **完善执行追踪**
  - [ ] 集成AgentExecutionTracker
  - [ ] 完善错误处理和恢复
  - [ ] 优化执行状态管理

#### 3.2 通知系统优化
- [ ] **集成通知任务管理**
  - [ ] 使用NotificationTaskManager
  - [ ] 实现通知去重机制
  - [ ] 优化通知状态追踪

- [ ] **优化业务通知**
  - [ ] 简化通知发送逻辑
  - [ ] 完善错误处理
  - [ ] 添加重试机制

### Phase 4: 测试和验证 (Day 4)

#### 4.1 功能测试
- [ ] **更新测试用例**
  - [ ] 更新Agent工具测试
  - [ ] 更新数据库操作测试
  - [ ] 更新业务逻辑测试

- [ ] **集成测试**
  - [ ] 端到端流程测试
  - [ ] 数据一致性验证
  - [ ] 性能基准测试

#### 4.2 兼容性验证
- [ ] **功能兼容性**
  - [ ] 验证所有现有功能正常
  - [ ] 确保Web界面正常工作
  - [ ] 验证通知系统正常

- [ ] **数据兼容性**
  - [ ] 验证数据迁移正确
  - [ ] 确保历史数据可访问
  - [ ] 验证配置系统正常

## 🔧 技术实施细节

### 数据库迁移策略
```sql
-- 1. 备份现有数据
CREATE TABLE tasks_backup AS SELECT * FROM tasks;
CREATE TABLE notifications_backup AS SELECT * FROM notifications;

-- 2. 创建新表结构
-- (详细SQL见架构文档)

-- 3. 数据迁移 (如果需要)
-- 将有用的历史数据迁移到新表结构

-- 4. 删除旧表 (确认无问题后)
DROP TABLE tasks;
-- 重命名notifications表或保留作为历史记录
```

### 代码重构策略
```python
# 1. 渐进式重构
# - 先添加新功能，再移除旧功能
# - 保持向后兼容性

# 2. 接口保持稳定
# - Web界面调用的接口保持不变
# - 内部实现逐步替换

# 3. 配置驱动
# - 通过配置控制新旧逻辑切换
# - 便于回滚和调试
```

### 测试策略
```python
# 1. 单元测试
# - 每个新组件都有对应测试
# - 覆盖核心业务逻辑

# 2. 集成测试
# - 验证组件间协作
# - 端到端流程测试

# 3. 回归测试
# - 确保现有功能不受影响
# - 性能不降级
```

## 📊 风险控制

### 技术风险
- **数据丢失风险**: 完整的数据备份和迁移验证
- **功能回退风险**: 保持旧代码分支，支持快速回滚
- **性能影响风险**: 性能基准测试和监控

### 业务风险
- **服务中断风险**: 分阶段部署，最小化影响时间
- **功能缺失风险**: 完整的功能测试和验证
- **用户体验风险**: 保持界面和操作流程不变

### 缓解措施
- **分支管理**: 使用feature分支进行重构
- **渐进部署**: 分阶段验证和部署
- **监控告警**: 完善的系统监控
- **快速回滚**: 准备回滚方案和脚本

## 🎯 成功标准

### 技术指标
- [ ] 所有现有功能正常工作
- [ ] 代码复杂度降低30%以上
- [ ] 测试覆盖率保持90%以上
- [ ] 性能不降级

### 业务指标
- [ ] 用户界面和操作流程无变化
- [ ] 通知功能正常工作
- [ ] 数据分析功能正常
- [ ] 系统稳定性保持

### 架构指标
- [ ] 概念清晰，职责明确
- [ ] 数据流简洁，易于理解
- [ ] 扩展性良好，便于维护
- [ ] 文档与代码同步

---

**重构原则**: 保持功能稳定，优化内部架构，提升长期可维护性
