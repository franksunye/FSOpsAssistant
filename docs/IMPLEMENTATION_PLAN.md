# FSOA 真实业务集成实施计划

**版本**: v1.0  
**开始时间**: 2025-06-25  
**预计完成**: 2025-07-09 (2周)

## 🎯 实施目标

将 FSOA 从演示原型转换为真实业务应用，实现：
1. ✅ 与 Metabase Card 1712 的真实数据连接
2. 🔄 基于真实业务规则的逾期检测和通知
3. ⏳ 运营仪表板展示真实数据和业务指标
4. ⏳ 完整的企微群分级通知机制

## 📊 当前进度 (Day 2 完成)

### ✅ 已完成的里程碑
- **Metabase 集成**: 成功连接并获取 47 条真实商机数据
- **数据解析**: 正确处理字段映射和时间格式
- **业务逻辑**: SLA 规则和逾期检测完全正常
- **数据验证**: 识别出 31 个逾期商机，涉及 10 个组织
- **分级通知系统**: 实现orgName到企微群的映射和升级通知机制
- **业务指标计算**: 完成逾期率、处理时长、组织绩效等关键指标
- **Web界面优化**: 新增业务分析、商机列表、企微群配置等页面
- **配置管理**: 实现企微群配置的Web界面管理和API

### 🎯 真实业务数据概览
- **总商机数**: 47 条
- **逾期商机**: 31 个 (66% 逾期率)
- **需要升级**: 24 个 (超过升级阈值)
- **涉及组织**: 10 个不同公司
- **最严重逾期**: 240+ 小时 (待预约状态)

## 📅 详细时间计划

### 第一周：数据集成和业务逻辑 (6月25日-7月1日)

#### Day 1 (6月25日): Metabase 数据集成 ✅ 已完成
**目标**: 实现真实数据获取和解析

**上午任务**: ✅ 完成
- [x] 分析 Metabase Card 1712 的数据结构
- [x] 实现 `/api/card/1712/query` 数据获取
- [x] 编写数据解析和验证逻辑

**下午任务**: ✅ 完成
- [x] 处理数据异常和边界情况 (字段映射、时间解析)
- [x] 实现数据缓存机制
- [x] 编写单元测试

**交付物**: ✅ 完成
- [x] 更新的 `metabase.py` 模块
- [x] 新增 `OpportunityInfo` 数据模型
- [x] 数据获取和解析的测试脚本 (`test_metabase_integration.py`)
- [x] 真实业务数据验证 (47条记录，31个逾期商机)

#### Day 2 (6月26日): 通知系统和业务规则优化 ✅ 已完成
**目标**: 实现分级通知机制和内容格式化

**上午任务**: ✅ 完成
- [x] 实现通知内容格式化 (按您提供的模板)
- [x] 开发 orgName 到 webhook URL 的映射配置
- [x] 实现标准通知和升级通知的分级机制

**下午任务**: ✅ 完成
- [x] 开发企微群配置管理界面
- [x] 实现通知频率控制和去重机制
- [x] 集成到 Agent 工作流

**交付物**: ✅ 完成
- [x] 更新的 `wechat.py` 通知模块
- [x] 新增 `business_formatter.py` 业务通知格式化模块
- [x] 新增 `wechat_config.py` 企微群配置管理模块
- [x] 新增 `business_metrics.py` 业务指标计算模块
- [x] 分级通知的测试用例和验证脚本

#### Day 3 (6月27日): 通知系统优化
**目标**: 实现分级通知和内容格式化

**上午任务**:
- [ ] 实现 orgName 到 webhook 的映射配置
- [ ] 开发标准通知内容格式化
- [ ] 实现内部运营群升级通知

**下午任务**:
- [ ] 实现 @人员功能
- [ ] 开发通知频率控制机制
- [ ] 测试各种通知场景

**交付物**:
- 更新的 `wechat.py` 通知模块
- 通知模板和配置
- 通知系统测试用例

#### Day 4 (6月28日): Agent 工作流集成
**目标**: 集成真实数据到 Agent 工作流

**上午任务**:
- [ ] 更新 `fetch_overdue_tasks` 使用真实数据
- [ ] 集成新的业务规则到 Agent 决策
- [ ] 更新 Agent 状态管理

**下午任务**:
- [ ] 实现完整的端到端工作流
- [ ] 优化 Agent 执行性能
- [ ] 测试 Agent 在真实数据下的表现

**交付物**:
- 更新的 `tools.py` 和 `orchestrator.py`
- 完整的 Agent 工作流测试
- 性能基准测试结果

#### Day 5 (6月29日): 测试和验证
**目标**: 全面测试真实数据集成

**上午任务**:
- [ ] 端到端数据流测试
- [ ] 边界情况和异常处理测试
- [ ] 性能和稳定性测试

**下午任务**:
- [ ] 修复发现的问题
- [ ] 优化代码和配置
- [ ] 准备第二周的 Web 界面开发

**交付物**:
- 完整的测试报告
- 问题修复记录
- 第一周总结文档

### 第二周：Web界面和运营功能 (7月2日-7月8日)

#### Day 6 (7月2日): 运营仪表板开发
**目标**: 实现真实数据的可视化展示

**上午任务**:
- [ ] 设计运营仪表板布局
- [ ] 实现实时逾期任务统计
- [ ] 开发任务状态分布图表

**下午任务**:
- [ ] 实现组织绩效对比
- [ ] 开发逾期时长分布图
- [ ] 添加数据刷新机制

**交付物**:
- 更新的 Streamlit 仪表板
- 数据可视化组件
- 用户界面设计文档

#### Day 7 (7月3日): 配置管理界面
**目标**: 实现企微群和业务规则配置

**上午任务**:
- [ ] 开发企微群配置管理界面
- [ ] 实现 orgName 到 webhook 映射编辑
- [ ] 添加配置测试功能

**下午任务**:
- [ ] 开发业务规则配置界面
- [ ] 实现 SLA 阈值动态调整
- [ ] 添加配置导入导出功能

**交付物**:
- 配置管理界面
- 配置验证和测试功能
- 配置文档和说明

#### Day 8 (7月4日): 历史分析功能
**目标**: 实现趋势分析和效果评估

**上午任务**:
- [ ] 设计历史数据存储结构
- [ ] 实现趋势分析图表
- [ ] 开发 SLA 达成率统计

**下午任务**:
- [ ] 实现组织绩效排名
- [ ] 开发通知效果分析
- [ ] 添加数据导出功能

**交付物**:
- 历史分析界面
- 趋势图表组件
- 数据导出功能

#### Day 9 (7月5日): 集成测试和优化
**目标**: 完整系统集成测试

**上午任务**:
- [ ] 完整业务流程测试
- [ ] Web 界面功能测试
- [ ] 用户体验优化

**下午任务**:
- [ ] 性能优化和调优
- [ ] 错误处理完善
- [ ] 文档更新

**交付物**:
- 集成测试报告
- 性能优化记录
- 用户操作手册

#### Day 10 (7月6日): 部署和验收
**目标**: 生产环境部署和最终验收

**上午任务**:
- [ ] 生产环境配置
- [ ] 系统部署和启动
- [ ] 监控和告警配置

**下午任务**:
- [ ] 用户验收测试
- [ ] 问题修复和调优
- [ ] 项目交付准备

**交付物**:
- 生产环境部署
- 验收测试报告
- 项目交付文档

## 🔧 技术实施细节

### 数据集成架构
```
Metabase API → 数据解析 → 业务规则引擎 → 通知系统
     ↓              ↓           ↓           ↓
   缓存层        数据验证    决策记录    通知记录
```

### 关键技术点

#### 1. Metabase 数据获取
```python
# 实现要点
- API 认证和会话管理
- 数据格式解析和验证
- 错误重试和降级处理
- 数据缓存和增量更新
```

#### 2. 业务规则引擎
```python
# 核心逻辑
- 时间计算和逾期判断
- 状态分类和优先级
- 升级条件检测
- 规则配置动态加载
```

#### 3. 通知系统
```python
# 功能特性
- 多群组消息路由
- 消息模板和格式化
- 频率控制和去重
- 发送状态跟踪
```

#### 4. Web 界面
```python
# 技术栈
- Streamlit 框架
- Plotly 图表库
- 实时数据更新
- 响应式设计
```

## 📊 质量保证

### 测试策略
1. **单元测试**: 每个模块 >90% 覆盖率
2. **集成测试**: 端到端业务流程验证
3. **性能测试**: 大数据量和并发测试
4. **用户测试**: 真实场景下的可用性测试

### 代码质量
- 代码审查和重构
- 类型注解和文档
- 错误处理标准化
- 日志记录完善

### 部署质量
- 环境配置标准化
- 监控和告警完善
- 备份和恢复机制
- 安全性检查

## 🎯 验收标准

### 功能验收
- [ ] 正确获取 Metabase Card 1712 数据
- [ ] 准确执行 SLA 规则和逾期检测
- [ ] 正确发送分级通知到对应企微群
- [ ] Web 界面展示真实业务数据
- [ ] 配置管理功能完整可用

### 性能验收
- [ ] 数据获取和处理延迟 < 5 分钟
- [ ] 通知发送延迟 < 1 分钟
- [ ] Web 界面响应时间 < 2 秒
- [ ] 系统连续稳定运行 > 72 小时

### 业务验收
- [ ] 运营人员能实时监控任务状态
- [ ] 销售人员能及时收到逾期提醒
- [ ] 管理人员能查看绩效分析
- [ ] 系统能自动处理日常监控工作

## 🚨 风险控制

### 技术风险
- **数据质量**: 多重验证和异常检测
- **API 稳定性**: 重试机制和降级方案
- **性能瓶颈**: 缓存和优化策略
- **集成复杂性**: 分步测试和验证

### 业务风险
- **需求变更**: 灵活的配置和扩展机制
- **用户接受度**: 渐进式部署和培训
- **数据安全**: 访问控制和审计日志
- **业务连续性**: 监控告警和快速恢复

### 应对措施
- 每日进度检查和风险评估
- 关键节点的里程碑验证
- 问题快速响应和解决机制
- 备选方案和降级策略

---

**下一步**: 开始 Day 1 的 Metabase 数据集成开发工作。
